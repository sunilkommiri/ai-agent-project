<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgraded AI Agent Builder (Web Access)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .log-entry {
            transition: all 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(10px);
        }
        .log-entry.visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white">Upgraded AI Agent Builder</h1>
            <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">An advanced agent with live Google Search and Web Browsing capabilities.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Configuration Panel -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-white flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                    1. Configure Your Agent
                </h2>
                <form id="agent-form">
                    <div class="mb-4">
                        <label for="agent-goal" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Agent's Core Objective</label>
                        <textarea id="agent-goal" rows="4" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., You are a helpful research assistant. Your goal is to find information and answer questions accurately.">You are a world-class researcher and analyst. Your goal is to decompose a user's request, use the available tools to gather information, and then synthesize that information into a final, comprehensive answer.</textarea>
                    </div>
                    <div class="mb-4">
                        <label for="agent-task" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">2. Assign a Task</label>
                        <input type="text" id="agent-task" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., What is the distance between the Earth and the Moon?" value="What were the main product announcements from Apple's latest event?">
                    </div>
                    <div class="flex justify-between items-center">
                       <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-all duration-300 shadow-md hover:shadow-lg">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2z"></polygon></svg>
                           Run Agent
                       </button>
                       <button type="button" id="reset-button" class="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg transition-colors">
                           Reset
                       </button>
                    </div>
                </form>
            </div>

            <!-- Execution Panel -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-white flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    3. Observe Execution
                </h2>
                <div id="final-answer-container" class="mb-4 p-4 bg-green-100 dark:bg-green-900/40 border border-green-300 dark:border-green-700 rounded-lg hidden">
                     <h3 class="font-semibold text-lg text-green-800 dark:text-green-200 mb-2">Final Answer:</h3>
                     <p id="final-answer" class="text-green-700 dark:text-green-300 whitespace-pre-wrap"></p>
                </div>
                <div id="thought-log-container" class="h-96 bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4 overflow-y-auto border border-gray-200 dark:border-gray-700 relative">
                    <div id="loading-spinner" class="absolute inset-0 bg-white/80 dark:bg-black/80 flex justify-center items-center rounded-lg hidden z-10">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                        <p class="ml-4 text-lg font-semibold">Agent is working...</p>
                    </div>
                    <div id="thought-log" class="space-y-4">
                        <p class="text-gray-500 dark:text-gray-400 text-center italic">Agent's thought process will appear here...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- DOM Element References ---
        const agentForm = document.getElementById('agent-form');
        const agentGoalInput = document.getElementById('agent-goal');
        const agentTaskInput = document.getElementById('agent-task');
        const thoughtLog = document.getElementById('thought-log');
        const finalAnswerContainer = document.getElementById('final-answer-container');
        const finalAnswerEl = document.getElementById('final-answer');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resetButton = document.getElementById('reset-button');
        
        // --- Gemini API Configuration ---
        // PASTE YOUR KEY HERE
        const API_KEY = "AIzaSyDS4rIhOSz5-tbPPzUdI18c5JnEOF3M9sA"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

        // --- Agent Tools Definition ---
        const TOOLS = {
            google_search: {
                description: "Finds relevant URLs for a given query using a search engine. Use this as the first step to find information on the web.",
                execute: async (args) => {
                    logToUI(`Searching Google for: "${args.query}"`, 'action', 'search');
                    // In a real app, this would use a Search API. We'll simulate it with Gemini for this demo.
                    const searchPrompt = `Provide a list of 3-5 relevant URLs for the search query: "${args.query}". Return only a JSON array of strings in a markdown block. Example: \`\`\`json\n["https://www.example.com/page1", "https://www.example.com/page2"]\`\`\``;
                    try {
                        const rawResponse = await callGemini(searchPrompt, 0.0);
                        const jsonString = rawResponse.match(/```json\n([\s\S]*?)\n```/)[1];
                        const urls = JSON.parse(jsonString);
                        return `Found the following URLs: ${urls.join(', ')}`;
                    } catch(e) {
                        return "Error performing search. Could not find any URLs."
                    }
                }
            },
            browse_webpage: {
                description: "Reads the content of a single webpage URL to extract information. Use this after `google_search` to get details from a specific page.",
                execute: async (args) => {
                    logToUI(`Browsing URL: "${args.url}"`, 'action', 'browse');
                    // In a real app, this would fetch and parse the webpage. We'll simulate it for this demo.
                    const browsePrompt = `Based on the URL "${args.url}", please provide a summary of the webpage's content relevant to the user's original task: "${agentTaskInput.value}". Focus on extracting key facts and information.`;
                    const summary = await callGemini(browsePrompt, 0.5);
                    return `Summary of ${args.url}: ${summary}`;
                }
            },
            calculator: {
                description: "Calculates the result of a mathematical expression. Input should be a valid mathematical string like '2 * (5 + 3)'",
                execute: async (args) => {
                    logToUI(`Calculating: "${args.expression}"`, 'action', 'calculate');
                    try {
                        // WARNING: eval() is used for simplicity. In a production app, use a safer math parsing library.
                        const result = eval(args.expression);
                        return `The result of the calculation is ${result}.`;
                    } catch (error) {
                        return `Error calculating expression: ${error.message}`;
                    }
                }
            },
            finish: {
                description: "Provides the final, conclusive answer to the user's original task. Use this only when you have all the necessary information.",
                execute: async (args) => {
                    logToUI(`Finalizing answer.`, 'action', 'finish');
                    return args.answer;
                }
            }
        };

        // --- Main Agent Logic ---

        async function runAgent(goal, task) {
            resetUI();
            loadingSpinner.classList.remove('hidden');
            
            let history = [];
            let maxSteps = 7; // Increased steps for multi-step web search

            for (let i = 0; i < maxSteps; i++) {
                const prompt = buildAgentPrompt(goal, task, history);
                
                logToUI(`<strong>Step ${i + 1}: Thinking...</strong>`, 'system');

                const rawResponse = await callGemini(prompt, 0.2);

                let thoughtAndAction;
                try {
                    const jsonString = rawResponse.match(/```json\n([\s\S]*?)\n```/)[1];
                    thoughtAndAction = JSON.parse(jsonString);
                } catch (error) {
                    logToUI(`Error parsing LLM response. The agent may be stuck or finished. Raw response: <pre class="whitespace-pre-wrap text-xs">${rawResponse}</pre>`, 'error');
                    if (rawResponse.toLowerCase().includes("final answer")) {
                         displayFinalAnswer(rawResponse);
                    }
                    loadingSpinner.classList.add('hidden');
                    return;
                }
                
                logToUI(`<em>"${thoughtAndAction.thought}"</em>`, 'thought');
                
                const toolName = thoughtAndAction.action.tool;
                const toolArgs = thoughtAndAction.action.args;

                if (!TOOLS[toolName]) {
                    logToUI(`Error: Agent tried to use an unknown tool: "${toolName}"`, 'error');
                    loadingSpinner.classList.add('hidden');
                    return;
                }

                if (toolName === 'finish') {
                    displayFinalAnswer(toolArgs.answer);
                    history.push({ role: 'assistant', thought: thoughtAndAction.thought, action: thoughtAndAction.action });
                    break;
                }

                const observation = await TOOLS[toolName].execute(toolArgs);
                logToUI(`Result: ${observation}`, 'observation');

                history.push({
                    role: 'assistant',
                    thought: thoughtAndAction.thought,
                    action: thoughtAndAction.action,
                    observation: observation,
                });
                
                if (i === maxSteps - 1) {
                    logToUI(`Max steps reached. The agent will now attempt to provide a final answer based on the information gathered so far.`, 'system');
                    const finalPrompt = `Based on the following history, please provide a comprehensive final answer to the user's task: "${task}".\n\nHistory:\n${JSON.stringify(history, null, 2)}`;
                    const finalAnswer = await callGemini(finalPrompt, 0.7);
                    displayFinalAnswer(finalAnswer);
                }
            }
            loadingSpinner.classList.add('hidden');
        }

        // --- Prompt & API Functions ---
        
        function buildAgentPrompt(goal, task, history) {
            const toolDescriptions = Object.entries(TOOLS).map(([key, value]) => `  - ${key}: ${value.description}`).join('\n');

            const historyString = history.map(turn => {
                return `Thought: ${turn.thought}\nAction: ${JSON.stringify(turn.action)}\nObservation: ${turn.observation}`;
            }).join('\n\n');

            return `You are an autonomous AI agent with a specific goal and access to a suite of tools.

**Core Objective:**
${goal}

**Available Tools:**
You have access to the following tools. You must use them sequentially. For web research, first use 'google_search' to find URLs, then use 'browse_webpage' on one of those URLs.
${toolDescriptions}

**Task:**
Fulfill the following request: "${task}"

**Process:**
1.  **Think**: Analyze the task and your history. Decide on the next logical step.
2.  **Act**: Choose ONE tool to execute. Respond with a single JSON object in a markdown code block.

**History of your work so far:**
${historyString.length > 0 ? historyString : 'No actions taken yet.'}

**Your Response:**
You MUST respond with a single JSON object in a markdown code block. The JSON object must have two keys: "thought" and "action".
- "thought": A string explaining your reasoning for the chosen action.
- "action": An object with two keys: "tool" (the name of the tool to use) and "args" (an object of arguments for that tool).

Now, based on the history and the task, what is your next thought and action?
`;
        }
        
        async function callGemini(prompt, temperature = 0.2) {
            try {
                if (!API_KEY || API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                    throw new Error("API Key is missing. Please add it to the index.html file.");
                }
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature, maxOutputTokens: 2048 }
                };
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                   return result.candidates[0].content.parts[0].text;
                } else {
                   console.error("Unexpected API response:", result);
                   const feedback = result.promptFeedback?.blockReason || 'Unknown error';
                   return `API Call Blocked: ${feedback}`;
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return `Error: Could not connect to the AI model. ${error.message}`;
            }
        }
        
        // --- UI Helper Functions ---

        function logToUI(message, type, iconType) {
            const entry = document.createElement('div');
            let icon = '';
            let bgColor = 'bg-gray-100 dark:bg-gray-800/60';
            
            iconType = iconType || type;

            switch(iconType) {
                case 'thought':
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-purple-500"><path d="M12 2a10 10 0 0 0-10 10c0 4.42 2.87 8.17 6.84 9.5.6.11.82-.26.82-.57 0-.28-.01-1.02-.01-2-2.78.6-3.37-1.34-3.37-1.34-.55-1.4-1.34-1.77-1.34-1.77-1.08-.74.08-.73.08-.73 1.2.08 1.83 1.23 1.83 1.23 1.07 1.83 2.8 1.3 3.48 1 .1-.78.42-1.3.76-1.6-2.66-.3-5.46-1.33-5.46-5.93 0-1.31.47-2.38 1.23-3.22-.12-.3-.54-1.52.12-3.18 0 0 1-.32 3.3 1.23.95-.26 1.98-.4 3-.4s2.05.13 3 .4c2.28-1.55 3.28-1.23 3.28-1.23.66 1.66.24 2.88.12 3.18.77.84 1.23 1.91 1.23 3.22 0 4.61-2.8 5.63-5.48 5.93.43.37.82 1.1.82 2.22 0 1.6-.01 2.89-.01 3.28 0 .31.22.69.83.57A10 10 0 0 0 12 2z"/></svg>`;
                    break;
                case 'search':
                     icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-blue-500"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`;
                    break;
                case 'browse':
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-teal-500"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`;
                    break;
                case 'calculate':
                     icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-orange-500"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="10" x2="8" y2="10"></line><line x1="16" y1="14" x2="8" y2="14"></line><line x1="16" y1="18" x2="8" y2="18"></line><line x1="8" y1="6" x2="8" y2="18"></line></svg>`;
                    break;
                case 'finish':
                     icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-green-500"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                    break;
                case 'observation':
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-gray-500"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
                    bgColor = 'bg-gray-100 dark:bg-gray-800';
                    break;
                case 'error':
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-red-500"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`;
                    bgColor = 'bg-red-50 dark:bg-red-900/20';
                    break;
                case 'system':
                     icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-gray-400"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>`;
            }

            entry.className = `log-entry p-3 rounded-lg flex items-start space-x-3 ${bgColor}`;
            entry.innerHTML = `${icon}<div class="prose prose-sm dark:prose-invert max-w-none pt-0.5">${message}</div>`;
            if (thoughtLog.children.length === 1 && thoughtLog.children[0].innerText.includes("thought process will appear here")) {
                 thoughtLog.innerHTML = '';
            }
            thoughtLog.appendChild(entry);
            
            setTimeout(() => entry.classList.add('visible'), 10);
            thoughtLog.parentElement.scrollTop = thoughtLog.parentElement.scrollHeight;
        }

        function resetUI() {
            thoughtLog.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center italic">Agent's thought process will appear here...</p>`;
            finalAnswerContainer.classList.add('hidden');
            finalAnswerEl.textContent = '';
        }

        function displayFinalAnswer(answer) {
            finalAnswerEl.textContent = answer;
            finalAnswerContainer.classList.remove('hidden');
        }

        // --- Event Listeners ---
        agentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const goal = agentGoalInput.value;
            const task = agentTaskInput.value;
            if (task) {
                runAgent(goal, task);
            }
        });
        
        resetButton.addEventListener('click', () => {
             resetUI();
             agentTaskInput.value = "What were the main product announcements from Apple's latest event?";
             agentGoalInput.value = "You are a world-class researcher and analyst. Your goal is to decompose a user's request, use the available tools to gather information, and then synthesize that information into a final, comprehensive answer.";
        });
    </script>
</body>
</html>
